#!/bin/bash
# Pre-commit hook: Prevent accidental secret commits
# Install: git config core.hooksPath .githooks

echo "üîç Scanning for secrets..."

# Patterns that indicate leaked credentials
PATTERNS=(
  'sk-[a-zA-Z0-9]{20,}'           # OpenAI keys
  'sk-ant-[a-zA-Z0-9]{20,}'       # Anthropic keys
  'pat-na[0-9]-[a-f0-9-]{36}'     # HubSpot PATs
  'AKIA[A-Z0-9]{16}'              # AWS Access Keys
  'ghp_[a-zA-Z0-9]{36}'           # GitHub PATs
  'ghs_[a-zA-Z0-9]{36}'           # GitHub App tokens
  'xox[bpoas]-[a-zA-Z0-9-]+'      # Slack tokens
)

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -v node_modules | grep -v '.env.example')

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

FOUND=0
for pattern in "${PATTERNS[@]}"; do
  MATCHES=$(echo "$STAGED_FILES" | xargs grep -lnE "$pattern" 2>/dev/null)
  if [ -n "$MATCHES" ]; then
    echo "‚ùå Potential secret found matching pattern: $pattern"
    echo "$MATCHES"
    FOUND=1
  fi
done

# Block .env files from being committed
ENV_FILES=$(git diff --cached --name-only | grep -E '\.env$|\.env\.local$|\.env\.production$')
if [ -n "$ENV_FILES" ]; then
  echo "‚ùå Blocked .env file from commit:"
  echo "$ENV_FILES"
  FOUND=1
fi

if [ $FOUND -eq 1 ]; then
  echo ""
  echo "üö´ Commit blocked. Remove secrets before committing."
  echo "   If this is a false positive, use: git commit --no-verify"
  exit 1
fi

echo "‚úÖ No secrets detected."
exit 0
